#! /bin/sh
#
# Makefile helper script for the Fast Light Tool Kit (FLTK) documentation.
#
# Copyright 1998-2025 by Bill Spitzak and others.
#
# This library is free software. Distribution and use rights are outlined in
# the file "COPYING" which should have been included with this file.  If this
# file is missing or damaged, see the license at:
#
#     https://www.fltk.org/COPYING.php
#
# Please see the following page on how to report bugs and issues:
#
#      https://www.fltk.org/bugs.php
#

# This script generates latex/refman.pdf after doxygen has been executed.
#
# Input:  run `doxygen Doxybook' (creates files in subdirectory latex)
# Output: latex/refman.pdf (if successful)
#
# Next step: cp -f latex/refman.pdf fltk.pdf (why is this extra step needed ?)
#
# Working directory: fltk/documentation
#
# Used in: documentation/CMakeLists.txt
#
# Usage:
#
#   $ make_pdf
#
# Note: FLTK_LATEX_CMD (below) is substituted by CMake to either 'latex' or 'lualatex'.
#   If it is 'latex', then 'pdflatex' is actually used to build the PDF file.
#

LATEX_CMD="@FLTK_LATEX_CMD@"

run_pdflatex() {

  echo "--- make_pdf in $PWD - executing 'run_pdflatex() with LATEX_CMD = '$LATEX_CMD'"
  echo "--- ...   using PDF_DATE = \"@PDF_DATE@\"."

  if [ x$LATEX_CMD = "xlatex" ] ; then
    pdflatex --interaction=nonstopmode refman
  else
    $LATEX_CMD --interaction=nonstopmode refman
  fi
}

( cd latex
  run_pdflatex
  makeindex refman.idx
  run_pdflatex
  latex_count=5
  while egrep -s 'Rerun (LaTeX|to get cross-references right)' refman.log \
	  && [ $latex_count -gt 0 ]
    do
      echo "Rerunning pdflatex ..."
      run_pdflatex
      latex_count=`expr $latex_count - 1`
    done
  cd ..) > pdfall.log 2>&1
